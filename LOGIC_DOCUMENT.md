# 项目数据关联逻辑文档

## 1. 简介

本文档旨在详细阐述本协作平台项目中各个核心数据模型之间的关联关系，以便于未来的功能开发与维护。

本系统的核心是“待办事项 (Todo)”，所有其他数据模型（如进度、物品、用户等）都直接或间接地围绕它展开。

## 2. 核心数据模型

以下是构成本系统的主要数据实体：

| 模型 | 中文名 | 主要职责 |
| :--- | :--- | :--- |
| **Todo** | 待办事项 | 系统的核心，代表一项需要完成的任务。 |
| **Progress** | 进度 | 对某个待办事项的进展更新。 |
| **Item** | 物品 | 需要在团队成员间交接保管的实体物品。 |
| **User** | 用户 | 系统的操作者，可以是创建人、指派人或保管人。 |
| **Attachment** | 附件 | 依附于其他模型的文件（图片、PDF等）。 |
| **Activity Log**| 操作历史 | 记录对某个待办事项的所有关键操作。 |

## 3. 详细关联关系

下面详细说明各个模型之间的关联方式。

### 3.1. 待办事项 (Todo) 的关联

**Todo** 是最核心的模型，它包含了多个对其他模型的引用。

-   **Todo <-> Progress (一对多)**
    -   **关系**: 一个 `Todo` 可以拥有多个 `Progress` 更新。
    -   **实现**: 在 `Todo` 对象中，有一个名为 `progress` 的**数组**。每个 `Progress` 对象被创建后，都会被直接**推入 (push)** 到其所属 `Todo` 的这个数组中。链接关系是通过**数据包含**实现的。

-   **Todo <-> Item (一对多)**
    -   **关系**: 一个 `Todo` 可以关联多个 `Item`。这种关联是**可选的**。
    -   **实现**: 在 `Item` 对象中，有一个**可选**的 `todoId` 字段。该字段的值就是其所关联的 `Todo` 的 `id`。前端通过筛选所有 `Item` 的 `todoId` 来展示与某个 `Todo` 相关的物品列表。

-   **Todo <-> User (多对多，通过不同字段体现)**
    -   **关系**: 用户以不同角色（创建者、负责人等）参与到一个 `Todo` 中。
    -   **实现**: `Todo` 对象通过以下字段引用 `User.username`：
        -   `creatorId`: 任务的创建者。
        -   `ownerId`: 任务当前的负责人或指派对象。
        -   `completedBy`: 任务的完成者。

-   **Todo <-> Activity Log (一对多)**
    -   **关系**: 一个 `Todo` 拥有一个完整的操作历史记录。
    -   **实现**: `Todo` 对象中有一个名为 `activityLog` 的**数组**，其中包含了该 `Todo` 从创建到现在的每一次关键状态变更记录。

-   **Todo <-> Attachment (一对一)**
    -   **关系**: 一个 `Todo` 本身可以附带一个附件。
    -   **实现**: `Todo` 对象中有一个 `attachmentUrl` 字段（对于旧数据，字段名为 `imageUrl`），用于存储附件的元数据。

### 3.2. 其他模型的关联

-   **Progress <-> Attachment (一对多)**
    -   **关系**: 一条 `Progress` 更新可以包含多个附件。
    -   **实现**: `Progress` 对象中有一个名为 `attachmentUrls` 的**数组**（对于旧数据，字段名为 `imageUrls`），存储其所有附件的元数据。

-   **Item <-> User (多对多，带历史记录)**
    -   **关系**: 一个 `Item` 在其生命周期内可以被多个 `User` 保管。
    -   **实现**: `Item` 对象中有一个名为 `keepers` 的**数组**。这个数组不仅记录了**当前**的保管人，还记录了**历史**交接记录。数组中的每一项都是一个包含 `userIds` (保管人列表), `timestamp` (交接时间) 和 `transferredBy` (操作人) 的对象。

-   **Item <-> Attachment (一对一)**
    -   **关系**: 一个 `Item` 可以附带一个附件。
    -   **实现**: `Item` 对象中有一个 `attachmentUrl` 字段（对于旧数据，字段名为 `imageUrl`）。

## 4. 数据流示例：添加一条新进度

为了更好地理解上述逻辑，以下是一个用户操作的完整数据流：

1.  **用户操作**: 用户在某个“待办事项”下方，填写了新的进度文本，并上传了一个PDF文件，然后点击“提交”。

2.  **前端 (`public/script.js`)**:
    -   `addProgress()` 函数被触发。
    -   它创建一个 `FormData` 对象，其中包含 `todoId` (告知后端要更新哪个待办事项)、进度 `text` 和上传的附件。
    -   向后端的 `/api/add_progress` 接口发送 `POST` 请求。

3.  **后端 (`functions/api/[[path]].js`)**:
    -   `handleAddProgress()` 函数处理该请求。
    -   它首先将附件上传到 Cloudflare R2 的 `attachments/` 目录，并获得一个唯一的URL。
    -   接着，它创建一个**附件对象**：`{ url: "...", name: "原始文件名.pdf", type: "application/pdf" }`。
    -   然后，它创建一个**进度对象**，将上述附件对象放入其 `attachmentUrls` 数组中。
    -   **关键一步**: 它根据 `todoId` 从 R2 加载对应的 `Todo` 对象。
    -   它将新创建的**进度对象**推入 (push) 到这个 `Todo` 对象的 `progress` 数组中。
    -   同时，它向 `Todo` 对象的 `activityLog` 数组中也推入一条“添加了新进度”的记录。
    -   最后，它将**整个被修改后的 `Todo` 对象**重新保存回 R2，完成数据更新。

4.  **前端更新**:
    -   请求成功后，前端调用 `refreshDataAndRender()` 函数。
    -   该函数会重新从 `/api/data` 获取最新的所有数据。
    -   `renderAllTodos()` 和 `renderProgress()` 函数被重新执行，在界面上渲染出包含新进度和附件链接的待办事项。

## 5. 关键代码位置

-   **后端总路由与核心逻辑**: `functions/api/[[path]].js`
-   **前端渲染与交互逻辑**: `public/script.js`
-   **页面基础 HTML 结构**: `public/index.html`
